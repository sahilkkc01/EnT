<!doctype html>
<html lang="en" class="light-style layout-menu-fixed layout-compact" dir="ltr" data-theme="theme-default"
  data-assets-path="../assets/" data-template="vertical-menu-template-free" data-style="light">

<head>
  <meta charset="utf-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

  <title>Add Employee</title>

  <%- include('../header') -%>

    <!-- Content wrapper -->
    <div class="content-wrapper">
      <!-- Content -->
      <style>
        .displaynone {
          display: none;
        }

        .bx-qr-scan {
          font-size: 80px;
        }
      </style>
      <div class="container-xxl flex-grow-1 container-p-y">
        <div class="row">
          <!-- Vertical & Horizontal Scrollbars -->
          <div class="col-12">
            <div class="card overflow-hidden">
              <h5 class="card-header">Add Employee</h5>
              <div class="card">
                <!-- Account -->
                <div class="card-body pt-4">
                  <form id="EmpForm" method="POST" enctype="multipart/form-data">
                    <div id="errordiv"></div>
                    <div class="row g-6">

                      <div class="col-md-6">
                        <label class="form-label" for="phoneNumber">Full Name*</label>
                        <div class="input-group">
                          <input type="text" id="name" name="name" class="form-control" placeholder=""
                            data-validation="required" data-error-message="Please Enter Name">
                        </div>
                      </div>
                      <div class="col-md-3">
                        <label for="language" class="form-label">UserName*</label>
                        <input class="form-control" type="text" id="username" name="username" value="" placeholder=""
                          data-validation="required" data-error-message="Please Enter UserName">
                      </div>
                      <div class="col-md-3">
                        <label for="language" class="form-label">Password*</label>
                        <input class="form-control" type="text" id="password" name="password" value="" placeholder=""
                          data-validation="required" data-error-message="Please Enter Password">
                      </div>
                      <div class="col-md-3">
                        <label for="language" class="form-label">Date of Birth</label>
                        <input type="date" id="dob" name="dob" class="form-control" placeholder="">
                      </div>
                      <div class="col-md-3">
                        <label for="language" class="form-label">Gender*</label>
                        <select id="gender" name="gender" class="select2 form-select" data-validation="required"
                          data-error-message="Please Enter Gender">
                          <option value="">Select</option>
                          <option value="M">Male</option>
                          <option value="F">Female</option>
                          <option value="O">Other</option>
                        </select>
                      </div>

                      <div class="col-md-3">
                        <label for="language" class="form-label">Phone Number*</label>
                        <input class="form-control" type="number" id="phoneNumber" name="phoneNumber" value=""
                          placeholder="" data-validation="required mobileNum"
                          data-error-message="Please Enter Phone Number">
                      </div>
                      <div class="col-md-3">
                        <label for="language" class="form-label">Email</label>
                        <input class="form-control" type="email" id="email" name="email" value="" placeholder=""
                          data-validation="email">
                      </div>
                      <div class="col-md-6">
                        <label for="language" class="form-label">Address</label>
                        <input class="form-control" type="text" id="address" name="address" value="" placeholder="">
                      </div>
                      <div class="col-md-3">
                        <label for="language" class="form-label">Department</label>
                        <select id="Department" name="dept" class="select2 form-select">
                          <option value="">Select</option>

                          <option value="add-new">Add New</option>
                        </select>
                      </div>
                      <div class="col-md-3">
                        <label for="language" class="form-label">Designation/Title</label>
                        <input class="form-control" type="text" id="desg" name="desg" value="" placeholder="">
                      </div>
                      <div class="col-md-3">
                        <label for="language" class="form-label">Date of Joining</label>
                        <input class="form-control" type="date" id="doj" name="doj" value="" placeholder="">
                      </div>
                      <div class="col-md-3">
                        <label for="language" class="form-label">Qualifications</label>
                        <input class="form-control" type="text" id="qualification" name="qualification" value=""
                          placeholder="">
                      </div>
                      <div class="col-md-3">
                        <label for="language" class="form-label">Experience</label>
                        <input class="form-control" type="text" id="exp" name="exp" value="" placeholder="">
                      </div>


                      <div class="col-md-3">
                        <label for="language" class="form-label">Shift Timing</label>
                        <select id="shiftTimming" name="shiftTimming" class="select2 form-select">
                          <option value="">Select</option>
                          <option value="Morning">Morning</option>
                          <option value="Evening">Evening</option>


                        </select>
                      </div>

                      <div class="col-md-3">
                        <label for="language" class="form-label">Emergency Contact(Name)</label>
                        <input class="form-control" type="text" id="emerCont" name="emerCont" value="" placeholder="">
                      </div>
                      <div class="col-md-3">
                        <label for="language" class="form-label">Emergency Contact(Mobile)</label>
                        <input class="form-control" type="number" id="emerContMobile" name="emerContMobile" value=""
                          placeholder="" data-validation="mobileNum">
                      </div>

                      <div class="col-md-3">
                        <label for="formFile" class="form-label">Employee Image</label>
                        <input class="form-control" type="file" id="empImage" name="empImage"
                          accept="image/png, image/jpeg">
                        <div id="imagePreview" class="mt-2 d-none">
                          <img id="previewImg" src="" alt="Employee Image" class="img-fluid rounded shadow-sm"
                            style="max-width: 100px; max-height: 100px; object-fit: cover;">
                        </div>
                        <small id="fileError" class="text-danger d-none">Invalid file! Only JPG, JPEG, PNG under 400KB
                          are allowed.</small>
                      </div>


                    </div>
                    <div id="loadingIndicator"></div>
                    <div class="mt-6">
                      <button type="submit" class="btn btn-primary me-3">Save</button>
                      <button type="reset" onclick=" window.location.href = '/HR/employees'"
                        class="btn btn-outline-secondary">Cancel</button>
                    </div>
                  </form>
                </div>
                <!-- /Account -->
              </div>
            </div>
          </div>
          <!--/ Vertical & Horizontal Scrollbars -->
        </div>
      </div>
      <!-- / Content -->
      <!-- Small Modal -->


      <div class="modal fade" id="smallModal2" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel2">Add Department</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col mb-6">
                  <label for="nameSmall" class="form-label">Department</label>
                  <input type="text" id="newDept" class="form-control" placeholder="" />
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                Close
              </button>
              <button type="button" id="addDept" class="btn btn-primary">Save</button>
            </div>
          </div>
        </div>
      </div>

      <%- include('../footer') -%>

       <script>
      $(document).ready(function () {
    console.log("Document is ready");

    const urlParams = new URLSearchParams(window.location.search);
    const empId = urlParams.get('id');
    const formId = '#EmpForm';
    const errorDivId = '#errordiv';
    const loadingDiv = '#loadingIndicator';
    let isUpdate = false; // Flag to check if updating

    if (empId) {
        isUpdate = true;
        fetchEmployeeDetails(empId);
    }else{
      loadDropdown('Department', 'Department', 'name', '');
    }

    async function fetchEmployeeDetails(empId) {
        try {
            const response = await axios.get(`/hr/emp-details/${empId}`);
            const empData = response.data.employee;
            console.log(empData);
            if (empData) {
                $('#name').val(empData.name);
                $('#username').val(empData.username);
                $('#password').val(empData.password);
                $('#dob').val(empData.dob);
                $('#gender').val(empData.gender);
                $('#phoneNumber').val(empData.phoneNumber);
                $('#email').val(empData.email);
                $('#address').val(empData.address);
                $('#desg').val(empData.desg);
                $('#doj').val(empData.doj);
                $('#qualification').val(empData.qualification);
                $('#exp').val(empData.exp);
                $('#shiftTimming').val(empData.shiftTimming);
                $('#emerCont').val(empData.emerCont);
                $('#emerContMobile').val(empData.emerContMobile);

                await loadDropdown('Department', 'Department', 'name', empData.dept);

                if (empData.empImage) {
                    $('#previewImg').attr('src', `/MyUploads/${empData.empImage}`);
                    $('#imagePreview').removeClass('d-none');
                }
            }
        } catch (error) {
            console.error("Error fetching employee details:", error);
            $(errorDivId).removeClass('alert-success').addClass('alert-danger').text("Failed to fetch employee details").show();
        }
    }

    
    // Load Department dropdown and set value if provided
    $('#Department').on('change', function () {
        if ($(this).val() === 'add-new') {
            $('#smallModal2').modal('show');
        }
    });

    $('#addDept').on('click', async function () {
        const newDept = $('#newDept').val();
        if (newDept) {
            try {
                await axios.post('/addDept', { dept: newDept });
                $('#smallModal2').modal('hide');
                loadDropdown('Department', 'Department', 'name', newDept);
                $('#newDept').val('');
            } catch (error) {
                console.log(error);
                alert(error.response.data.message);
            }
        } else {
            alert('Please enter a Department');
        }
    });

    restrictInput("phoneNumber", 10);
    restrictInput("emerContMobile", 10);

    $("#empImage").on("change", function (event) {
        const file = event.target.files[0];
        const fileError = $("#fileError");
        const previewDiv = $("#imagePreview");
        const previewImg = $("#previewImg");

        fileError.addClass("d-none");
        previewDiv.addClass("d-none");

        if (file) {
            const allowedTypes = ["image/jpeg", "image/png"];
            const maxSize = 400 * 1024; // 400KB in bytes

            if (!allowedTypes.includes(file.type) || file.size > maxSize) {
                fileError.removeClass("d-none");
                event.target.value = "";
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                previewImg.attr("src", e.target.result);
                previewDiv.removeClass("d-none");
            };
            reader.readAsDataURL(file);
        }
    });
});

       </script>